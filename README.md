Приложение IPsAPI и его назначение

Приложение IPsAPI представляет собой RESTful API, поддерживающий GET, POST и PUT запросы. Приложение может выполнять следующие функции:
- Передавать клиенту список IP адресов из БД;
- Обновлять БД: 
    - Добавлять в неё текущие значения IP адресов;
    - Удалять из БД неиспользуемые значения;
- Давать возможность клиенту редактировать данные IP адреса (добавлять комментарий) и сохранить изменения в БД.


Структура директорий и файлов

Приложение находится в директории ipsapi.
ipsapi/dbinit/ips_db.sql – файл, предназначенный для инициализации БД.
ipsapi/client – клиентская часть приложения (может располагаться на другом сервере, т. к. приложение поддерживает CORS).
ipsapi/client/extjs/ipgrid.js – файл, в котором определены компоненты клиентского интерфейса: Grid и ExtJS Form.
ipsapi/vendor – директория, где находятся сторонние компоненты приложения: Composer, Silex, Doctrine и т. д..
ipsapi/web – директория, в которой находится вся серверная часть приложения: контроллеры, модель, взаимодействие с БД.
ipsapi/web/.htaccess – содержит инструкции для корректной работы маршрутизации Silex.
ipsapi/web/config.php – конфигурация БД.
ipsapi/web/model – классы, соответствующие понятиям предметной области.
ipsapi/composer.json – список сторонних компонентов для установки Composer’ом.


Контроллеры

В файле web/index.php находятся три контроллера, написанные с использованием маршрутизации Silex:
- GET / - вычисляется текущий массив IP адресов и извлекается массив сохранённых в БД IP адресов. В случае возникновения ошибок, клиенту возвращается статус 500 Internal Server Error с соответствующим сообщением («Ошибка БД» или «Ошибка вычисления IP адресов»). Если в БД нет значений, то она заполняется значениями текущего массива. Клиенту возвращается список IP из БД в формате JSON.
- PUT /{id} – выполняется обновление записи в БД по указанному id. Возвращаемые статусы: 200 или 500.
- POST|GET /update – вычисляет текущий массив IP адресов и массив из БД. Сравнивает два массива. Заносит в БД разность текущего и сохранённого массива. Удаляет из БД разность сохранённого и текущего массивов. В случае возникновения ошибок возвращается статус 500 Internal Server Error с соответствующим сообщением («Ошибка БД» или «Ошибка вычисления IP адресов»). В случае успеха возвращается статус 200 OK.
Также есть функция, переопределяющая заголовки HTTP ответов для поддержки CORS.


Модель

Модель (web/model) состоит из двух классов: IPAddr и IPAddrList.
IPAddr – класс, воспроизводящий БД-сущность. Содержит поля: id, ip, comment, а также несколько конструкторов.
IPAddrList – класс, содержащий два массива объектов типа IPAddr: список, полученный в настоящий момент и взятый из БД. В классе имеются методы:
- getIPListFromDB() –получает список IP адресов из БД;
- getCurrentIPList() – вычисляет текущий список IP адресов с помощью PHP функций gethostbynamel(gethostname());
- insertIPsToDB() – находит разность текущего и сохранённого списка и заносит недостающие IP адреса а базу;
- deleteRedundantIPsFromDB() – находит разность сохранённого и текущего списка и удаляет из базы те IP адреса, которые в настоящий момент не используются;
- updateIPAddr($ipAddr) – принимает объект IP адреса и обновляет соответствующую ему запись в БД.


Клиентская часть

Файл index.html содержит ссылки на ExtJS CDN и подключает файл extjs/ipgrid.js. В ipgrid.js генерируются компоненты Ext.form.FormPanel и Ext.grid.Panel с плагином Ext.grid.plugin.RowEditing. Создаётся модель (Ext.data.Model), повторяющая серверный класс IPAddr.
FormPanel содержит кнопку submit, при нажатии на которую осуществляется POST (возможно использовать и GET) к API с параметром update. При получении ответа от сервера, обработчик события выводит сообщение (Ext.Msg.alert) успех/неуспех. В случае успеха, grid обновляет список.
При загрузке grid.Panel, модель отправляет GET запрос без параметров и получает список адресов в формате JSON. При редактировании записи посылается PUT запрос с параметром id.
